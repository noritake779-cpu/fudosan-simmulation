import streamlit as st
import pandas as pd
import numpy as np
import numpy_financial as npf
import plotly.graph_objects as go
import plotly.express as px
from datetime import datetime

# --- ãƒ­ãƒ¼ãƒ³è¨ˆç®—é–¢æ•° ---
def calculate_loan(amount, annual_rate, years, type="å…ƒåˆ©å‡ç­‰"):
    r = annual_rate / 12
    n = years * 12
    
    if amount == 0:
        return np.zeros(n), np.zeros(n), np.zeros(n)
        
    if type == "å…ƒåˆ©å‡ç­‰":
        monthly_payment = (amount * r * (1+r)**n) / ((1+r)**n - 1)
        payments = np.full(n, monthly_payment)
        interest = np.zeros(n)
        principal = np.zeros(n)
        balance = amount
        for i in range(n):
            interest[i] = balance * r
            principal[i] = monthly_payment - interest[i]
            balance -= principal[i]
    else:  # å…ƒæœ¬å‡ç­‰
        monthly_principal = amount / n
        principal = np.full(n, monthly_principal)
        interest = np.zeros(n)
        balance = amount
        for i in range(n):
            interest[i] = balance * r
            balance -= monthly_principal
        payments = principal + interest
        
    return payments, principal, interest

# --- ãƒ¡ã‚¤ãƒ³ãƒ­ã‚¸ãƒƒã‚¯ ---
st.set_page_config(page_title="REI Pro-Sim v2", layout="wide")
st.title("ğŸ¡ ä¸å‹•ç”£æŠ•è³‡ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ Pro v2")

# ã‚µã‚¤ãƒ‰ãƒãƒ¼è¨­å®š
with st.sidebar:
    st.header("ğŸ¢ ç‰©ä»¶ãƒ»èè³‡è©³ç´°")
    price = st.number_input("ç‰©ä»¶ä¾¡æ ¼ (å††)", value=100000000, step=1000000)
    building_ratio = st.slider("å»ºç‰©æ¯”ç‡ (%)", 0, 100, 60) / 100
    loan_amount = st.number_input("å€Ÿå…¥é¡ (å††)", value=80000000, step=1000000)
    loan_years = st.number_input("å€Ÿå…¥æœŸé–“ (å¹´)", value=30, min_value=1)
    loan_rate = st.slider("é‡‘åˆ© (%)", 0.0, 5.0, 2.0, step=0.1) / 100
    repayment_type = st.selectbox("è¿”æ¸ˆæ–¹å¼", ["å…ƒåˆ©å‡ç­‰", "å…ƒæœ¬å‡ç­‰"])
    
    st.header("ğŸ’° é‹ç”¨ãƒ»å£²å´")
    yield_rate = st.slider("æƒ³å®šè¡¨é¢åˆ©å›ã‚Š (%)", 3.0, 15.0, 7.0) / 100
    holding_period = st.slider("ä¿æœ‰æœŸé–“ (å¹´)", 1, 35, 10)
    exit_price_ratio = st.slider("å£²å´ä¾¡æ ¼æƒ³å®š (è³¼å…¥æ™‚æ¯” %)", 50, 120, 90) / 100

# 1. ãƒ­ãƒ¼ãƒ³è¨ˆç®—å®Ÿè¡Œ
m_pay, m_pri, m_int = calculate_loan(loan_amount, loan_rate, loan_years, repayment_type)

# 2. å¹´å˜ä½ã®é›†è¨ˆ
annual_repayment = []
annual_interest = []
for y in range(holding_period):
    annual_repayment.append(m_pay[y*12:(y+1)*12].sum())
    annual_interest.append(m_int[y*12:(y+1)*12].sum())

# 3. ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ãƒ­ãƒ¼è¨ˆç®—
df = pd.DataFrame({'Year': range(1, holding_period + 1)})
df['Income'] = price * yield_rate
df['Opex'] = df['Income'] * 0.20 # ç®¡ç†è²»ç­‰20%å›ºå®š
df['Repayment'] = annual_repayment
df['Net_CF'] = df['Income'] - df['Opex'] - df['Repayment']

# 4. IRRã®ç®—å‡º (æŠ•è³‡ã®å…¥ã‚Šå£ã‹ã‚‰å‡ºå£ã¾ã§)
# [0å¹´ç›®: -è‡ªå·±è³‡é‡‘, 1..Nå¹´ç›®: å¹´é–“CF, æœ€å¾Œ: å¹´é–“CF + å£²å´æ‰‹å–ã‚Š]
initial_investment = -(price - loan_amount) # è‡ªå·±è³‡é‡‘ (ãƒã‚¤ãƒŠã‚¹)
cash_flows = [initial_investment] + df['Net_CF'].tolist()

# å‡ºå£ã®è¨ˆç®— (å£²å´ä¾¡æ ¼ - ãƒ­ãƒ¼ãƒ³æ®‹å‚µ - è­²æ¸¡ç¨)
exit_price = price * exit_price_ratio
remaining_loan = loan_amount - m_pri[:holding_period*12].sum()
capital_gain = exit_price - remaining_loan # ç°¡æ˜“çš„ãªæ‰‹æ®‹ã‚Š
cash_flows[-1] += capital_gain

irr = npf.irr(cash_flows)

# --- çµæœè¡¨ç¤º ---
c1, c2, c3 = st.columns(3)
c1.metric("ç¨å¼•å‰CF (å¹³å‡)", f"Â¥{df['Net_CF'].mean():,.0f}")
c2.metric("IRR (å†…éƒ¨åç›Šç‡)", f"{irr*100:.2f}%" if irr else "è¨ˆç®—ä¸èƒ½")
c3.metric("å£²å´æ™‚ãƒ­ãƒ¼ãƒ³æ®‹å‚µ", f"Â¥{remaining_loan:,.0f}")

# ãƒ­ãƒ¼ãƒ³è¿”æ¸ˆã®å†…è¨³å¯è¦–åŒ–
st.subheader("ğŸ“Š è¿”æ¸ˆãƒ—ãƒ©ãƒ³ã¨åæ”¯æ§‹é€ ")
fig_loan = go.Figure()
fig_loan.add_trace(go.Bar(name='å…ƒæœ¬', x=df['Year'], y=np.array(annual_repayment)-np.array(annual_interest)))
fig_loan.add_trace(go.Bar(name='åˆ©æ¯', x=df['Year'], y=annual_interest))
fig_loan.update_layout(barmode='stack', title="å¹´é–“è¿”æ¸ˆé¡ã®å†…è¨³ (å…ƒæœ¬ vs åˆ©æ¯)")
st.plotly_chart(fig_loan, use_container_width=True)



st.subheader("ğŸ“ˆ ç´¯ç©ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ãƒ­ãƒ¼ã®æ¨ç§»")
df['Cumulative_CF'] = df['Net_CF'].cumsum() + initial_investment
fig_cum = px.area(df, x='Year', y='Cumulative_CF', title="è‡ªå·±è³‡é‡‘å›åã®æ¨ç§» (ãƒã‚¤ãƒŠã‚¹ã¯æœªå›å)")
st.plotly_chart(fig_cum, use_container_width=True)